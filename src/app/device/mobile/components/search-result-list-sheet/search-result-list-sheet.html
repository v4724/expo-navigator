<ion-modal
  #modal
  [style]="'--ion-background-color:transparent;'"
  [expandToScroll]="false"
  [initialBreakpoint]="0.75"
  [breakpoints]="[0, 0.5, 0.75, 1]"
  [backdropDismiss]="false"
  [backdropBreakpoint]="0.5"
>
  <ng-template>
    <ion-content
      class="mt-2 border-t rounded-t-lg border-gray-300/50 overflow-hidden bg-white dark:bg-zinc-800"
    >
      <div
        class="sticky top-0 z-1 p-4 pr-2 pb-3 flex shadow bg-white dark:bg-zinc-800 text-gray-600 dark:text-gray-50"
      >
        <ion-title class="">
          @if (isFiltering()) {
            <div class="flex items-center">
              搜尋結果：{{ list().length }} 筆
              <p-button
                class="ml-auto"
                icon="pi pi-filter-slash"
                [rounded]="true"
                [text]="true"
                size="small"
                (click)="clearFilter()"
              ></p-button>
            </div>
          } @else {
            <div class="">攤位列表</div>
          }
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="modal.dismiss()"><ion-icon name="close"></ion-icon></ion-button>
        </ion-buttons>
      </div>
      <div class="p-4 flex flex-col dark:bg-zinc-800 dark:text-gray-50">
        @if (isFiltering() && list().length === 0) {
          <div class="flex-1 flex items-center justify-center">無查詢結果</div>
        }

        @for (item of list(); track $index) {
          @if ($index > 0) {
            <p-divider></p-divider>
          }
          <div
            class="flex items-center w-full gap-4 transition hover:scale-102 hover:cursor-pointer"
            (click)="selectAndFocus(item)"
          >
            <div
              class="shrink w-[100px] h-[100px] rounded-lg border border-gray-400 overflow-hidden"
            >
              @if (item.stallImg) {
                @let isDefaultWixImg = item.stallImg.indexOf('static.wixstatic.com/media/') > -1;
                @if (isDefaultWixImg) {
                  @let imgName = item.stallImg.split('static.wixstatic.com/media/')[1];
                  <img
                    class="w-full h-full object-cover object-center"
                    [src]="
                      `${item.stallImg}/v1/fill/w_100,h_100,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/${imgName}`
                    "
                  />
                } @else {
                  <img class="w-full h-full object-cover object-center" [src]="item.stallImg" />
                }
              }
            </div>
            <div class="flex-1 flex flex-col gap-1">
              <div class="flex gap-1 items-center">
                <app-stall-zone-badge [stall]="item"></app-stall-zone-badge>
                <div class="mt-[2px]">{{ item.stallTitle }}</div>
              </div>
              @if (item.stallAuthor) {
                <div class="text-xs">{{ item.stallAuthor }}</div>
              }
              <div class="flex flex-wrap">
                @for (promo of item.promoData; track $index) {
                  @if ($index > 0) {
                    /
                  }
                  {{ promo.promoTitle }}
                }
              </div>
              <div class="flex flex-wrap gap-1 text-[10px]">
                <!-- 非 only 場顯示作品、only 場顯示 tag -->
                @if (multiSeriesExpo()) {
                  @for (series of item.filterSeries; track $index) {
                    <span class="promo-tag inline-flex"> #{{ series | seriesPipe }} </span>
                  }
                } @else {
                  @for (tags of item.filterTags; track $index) {
                    <span class="promo-tag inline-flex"> #{{ tags | tagPipe }} </span>
                  }
                }
                @if (item.filterCustomTags.length) {
                  @for (tag of item.filterCustomTags; track $index) {
                    <span class="promo-tag inline-flex"> #{{ tag }} </span>
                  }
                }
              </div>
            </div>
          </div>
        }
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
