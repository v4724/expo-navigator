<div id="app">
  <h1>NiCE 創·迴響 互動地圖</h1>
  <div class="legend-container">
    <div class="legend-item"><span class="legend-box legend-default"></span><span>攤位</span></div>
    <div class="legend-item"><span class="legend-box legend-promo"></span><span>宣傳車</span></div>
    <div class="legend-item">
      <span class="legend-box legend-search"></span><span>搜尋結果</span>
    </div>
    <div class="legend-item">
      <span class="legend-box legend-selected"></span><span>選擇中</span>
    </div>
  </div>

  <app-layers-controller></app-layers-controller>

  <p id="instructions-text" [ngClass]="{ 'loading-text': isInitialLoading() }">
    @if (isInitialLoading()) {
      正在載入地圖與攤位資料
    } @else if (isInitialError()) {
      {{ errorMsg }}
    } @else {
      @if (isMobile()) {
        點擊按鈕可用放大鏡，或直接點擊攤位查看宣傳。
      } @else {
        請與地圖互動以查看攤位資訊。 點擊按鈕顯示/隱藏放大鏡並拖曳。點擊攤位(含放大鏡內)可看宣傳。
      }
    }
  </p>

  <div class="search-container">
    <input
      type="search"
      #searchInput
      id="search-input"
      placeholder="搜尋攤位編號、名稱、作者或標籤..."
      aria-label="Search for stalls"
      (input)="input()"
    />
    <button #toggleButton id="toggle-magnifier-btn" (click)="toggleMagnifier()">顯示放大鏡</button>
  </div>

  <!-- Map container: will hold the map image and dynamically injected stall areas -->
  <div
    id="map-container"
    #mapContainer
    (mousedown)="mapContainerMousedown($event)"
    (touchstart)="mapContainerTouchstart($event)"
  >
    <img
      #mapImage
      id="map-image"
      [src]="mapImageSrc"
      alt="Neo iComic Echo Venue Map"
      (load)="onMapImageLoad()"
      (error)="onMapImageError()"
    />
    @if (isInitialLoading()) {
    } @else if (isInitialError()) {
      <p style="color: red; padding: 20px">
        <b>無法載入攤位資料：</b><br />請檢查您的 Google Sheet
        是否已「發佈至網路」、網址是否正確，或檢查您的網路連線。
      </p>
    } @else {
      <!-- Magnifier elements: wrapper handles positioning, lens handles visuals -->
      <app-magnifier></app-magnifier>
    }
    @for (stall of allStalls$ | async; track $index) {
      <app-stall [stall]="stall" [hiddenIfGrouped]="true" [absolutePosition]="true"></app-stall>
    }
    @for (row of stallGridRefs; track $index) {
      <app-stall-group-area [row]="row"></app-stall-group-area>
    }
  </div>

  <div class="recommendation-note">
    <p>為獲得較佳體驗，建議使用電腦瀏覽器並將視窗寬度調整至 1024px 以上。</p>
  </div>

  <div class="data-source">
    <h3 style="margin-bottom: 0px">資料來源</h3>
    <ul>
      <li>
        <a href="https://starstonetw.weebly.com/" target="_blank" rel="noopener noreferrer"
          >星石文創 NiCE 官網</a
        >
      </li>
    </ul>
  </div>

  <div style="margin-top: 0.5rem">
    <p style="margin-bottom: 0px">
      © 2025 阿圖　｜　本作品由原作者 阿圖 非官方製作，現由 NiCE 創·迴響 正式授權使用。
    </p>
  </div>
</div>

<app-tooptip></app-tooptip>

<!-- Modal dialog: for displaying detailed stall information. Hidden by default. -->
<!-- ARIA attributes ensure it's accessible to screen readers. -->
<app-stall-modal></app-stall-modal>

<!-- Image Lightbox for viewing images in detail -->
<app-lightbox></app-lightbox>
